# ServiceCountdownScreen 编译错误修复说明

## 错误信息

```
e: file:///Users/wajie/StudioProjects/longcare/app/src/main/kotlin/com/ytone/longcare/features/servicecountdown/ui/ServiceCountdownScreen.kt:194:35 
Unresolved reference 'stopLocationTracking'.
```

## 问题原因

在 `handleEndService()` 函数中，调用了不存在的方法 `locationTrackingViewModel.stopLocationTracking()`。

## 正确的方法名

通过查看 `LocationTrackingViewModel.kt` 源码，发现正确的方法名是 `onStopClicked()`：

```kotlin
@HiltViewModel
class LocationTrackingViewModel @Inject constructor(
    private val trackingManager: LocationTrackingManager
) : ViewModel() {

    val isTracking: StateFlow<Boolean> = trackingManager.isTracking

    fun onStartClicked(orderId: Long) {
        trackingManager.startTracking(orderId)
    }

    fun onStopClicked() {
        trackingManager.stopTracking()
    }
}
```

## 修复方案

### 修复前：
```kotlin
// 2. 停止定位跟踪服务
locationTrackingViewModel.stopLocationTracking()
```

### 修复后：
```kotlin
// 2. 停止定位跟踪服务
locationTrackingViewModel.onStopClicked()
```

## 完整的修复代码

```kotlin
// 处理结束服务的公共逻辑
fun handleEndService(endType: Int) {
    // 1. 停止倒计时前台服务
    CountdownForegroundService.stopCountdown(context)
    
    // 2. 停止定位跟踪服务
    locationTrackingViewModel.onStopClicked()  // ✅ 修复：使用正确的方法名
    
    // 3. 取消倒计时闹钟
    countdownNotificationManager.cancelCountdownAlarm()
    
    // 4. 停止响铃服务（如果正在响铃）
    AlarmRingtoneService.stopRingtone(context)
    
    // 5. 调用ViewModel结束服务
    countdownViewModel.endService(orderInfoRequest, context)
    
    // 6. 获取上传的图片列表
    val uploadedImages = countdownViewModel.getCurrentUploadedImages()
    val beginImgList = uploadedImages[ImageTaskType.BEFORE_CARE]?.mapNotNull { it.key } ?: emptyList()
    val centerImgList = uploadedImages[ImageTaskType.CENTER_CARE]?.mapNotNull { it.key } ?: emptyList()
    val endImgList = uploadedImages[ImageTaskType.AFTER_CARE]?.mapNotNull { it.key } ?: emptyList()

    // 7. 导航到NFC签到页面
    navController.navigateToNfcSignInForEndOrder(
        orderInfoRequest = orderInfoRequest,
        params = EndOderInfo(
            projectIdList = projectIdList.map { it.toInt() },
            beginImgList = beginImgList,
            centerImgList = centerImgList,
            endImgList = endImgList,
            endType = endType
        ),
    )
}
```

## 验证结果

### 编译验证：
```bash
./gradlew :app:compileDebugKotlin
```

### 结果：
- ✅ 编译通过
- ✅ 无错误
- ✅ 无警告

## LocationTrackingViewModel 方法说明

### 可用方法：

1. **onStartClicked(orderId: Long)**
   - 功能：启动定位跟踪服务
   - 参数：orderId - 订单ID
   - 使用场景：开始服务时调用

2. **onStopClicked()**
   - 功能：停止定位跟踪服务
   - 参数：无
   - 使用场景：结束服务时调用

3. **isTracking: StateFlow<Boolean>**
   - 功能：定位跟踪状态
   - 类型：StateFlow
   - 使用场景：监听定位服务状态

## 最佳实践

### 1. 方法命名规范
LocationTrackingViewModel 使用了 `onXxxClicked()` 的命名模式，表示这是UI事件的处理方法。

### 2. 调用示例
```kotlin
// 启动定位服务
locationTrackingViewModel.onStartClicked(orderId)

// 停止定位服务
locationTrackingViewModel.onStopClicked()

// 监听定位状态
val isTracking by locationTrackingViewModel.isTracking.collectAsStateWithLifecycle()
```

### 3. 服务停止顺序
在结束服务时，应该按照以下顺序停止各个服务：
1. 停止倒计时前台服务
2. 停止定位跟踪服务 ✅
3. 取消倒计时闹钟
4. 停止响铃服务
5. 调用ViewModel结束服务

## 总结

- ✅ 错误已修复
- ✅ 使用正确的方法名 `onStopClicked()`
- ✅ 编译通过
- ✅ 功能完整

修复后的代码符合项目规范，可以正常编译和运行。

---

**修复完成时间**: 2025年
**修复状态**: ✅ 完成
**编译状态**: ✅ 通过
