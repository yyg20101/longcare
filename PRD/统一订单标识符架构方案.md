# 统一订单标识符架构方案

## 设计目标
1. **统一入口**：整个应用使用同一个订单标识模型
2. **易扩展**：未来添加字段只需修改一处
3. **类型安全**：编译期检查，避免参数混淆

---

## 核心设计：创建 OrderKey

```kotlin
// model/OrderKey.kt
@Serializable
data class OrderKey(
    val orderId: Long,
    val planId: Int = 0
) {
    /** 用于缓存的唯一字符串Key */
    val cacheKey: String get() = "${orderId}_${planId}"
    
    companion object {
        fun fromCacheKey(key: String): OrderKey? {
            val parts = key.split("_")
            if (parts.size != 2) return null
            return OrderKey(
                orderId = parts[0].toLongOrNull() ?: return null,
                planId = parts[1].toIntOrNull() ?: return null
            )
        }
    }
}
```

---

## 模型整合

| 现有模型 | 处理方式 |
|----------|----------|
| `OrderNavParams` | **保留** - 导航专用（@Serializable） |
| `OrderInfoRequestModel` | **保留** - API请求专用 |
| `OrderKey` | **新增** - 内部统一标识符 |

### 转换扩展函数
```kotlin
// 在OrderKey.kt中添加扩展
fun OrderNavParams.toOrderKey() = OrderKey(orderId, planId)
fun OrderKey.toNavParams() = OrderNavParams(orderId, planId)
fun OrderInfoRequestModel.toOrderKey() = OrderKey(orderId, planId)
fun OrderKey.toRequestModel() = OrderInfoRequestModel(orderId, planId)
```

---

## 改造范围

### 1. UnifiedOrderRepository
```kotlin
// 使用OrderKey作为缓存Key
private val _cachedOrderInfo = ConcurrentHashMap<String, ServiceOrderInfoModel>()
//                                              ^^^^^^ 使用cacheKey

suspend fun getOrderInfo(orderKey: OrderKey, forceRefresh: Boolean = false)
fun getCachedOrderInfo(orderKey: OrderKey): ServiceOrderInfoModel?
```

### 2. 数据库改造（可选，如果planId影响数据唯一性）

> [!WARNING]
> 如果`orderId+planId`才能唯一标识一条记录，需要修改为复合主键。
> 这需要数据库迁移。

```kotlin
// OrderEntity.kt
@Entity(
    tableName = "orders",
    primaryKeys = ["order_id", "plan_id"]  // 复合主键
)
```

### 3. ViewModel改造
- `SharedOrderDetailViewModel`
- `EndServiceSelectionViewModel`  
- `IdentificationViewModel`
- `PhotoProcessingViewModel`
- `ServiceCountdownViewModel`

---

## 改造文件清单

#### [NEW] [OrderKey.kt](file:///Users/wajie/StudioProjects/longcare/app/src/main/kotlin/com/ytone/longcare/model/OrderKey.kt)

#### [MODIFY] [UnifiedOrderRepository.kt](file:///Users/wajie/StudioProjects/longcare/app/src/main/kotlin/com/ytone/longcare/data/repository/UnifiedOrderRepository.kt)
- 缓存Key改为`String`（使用`orderKey.cacheKey`）
- 所有方法参数改为`OrderKey`

#### [MODIFY] SharedOrderDetailViewModel.kt
- `getOrderInfo(orderKey: OrderKey)`
- `getCachedOrderInfo(orderKey: OrderKey)`

#### [MODIFY] 其他4个ViewModel
- 统一使用`OrderKey`

---

## 验证计划

```bash
./gradlew :app:compileDebugKotlin
```

---

## 用户决策点

> [!IMPORTANT]
> **需确认**：是否需要修改数据库为复合主键？
> 
> - 如果一个`orderId`可能对应多个`planId`的不同记录 → 需要复合主键
> - 如果`planId`只是附加信息，`orderId`仍唯一 → 保持现状

请确认后开始执行。
