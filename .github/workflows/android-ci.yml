name: Android CI

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "task_plan.md"
      - "findings.md"
      - "progress.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "task_plan.md"
      - "findings.md"
      - "progress.md"
  workflow_dispatch:

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_TOOL_OPTIONS: -Djava.awt.headless=true

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      affected_scope: ${{ steps.detect.outputs.affected_scope }}
      affected_modules: ${{ steps.detect.outputs.affected_modules }}
      verify_tasks: ${{ steps.detect.outputs.verify_tasks }}
      run_instrumentation: ${{ steps.detect.outputs.run_instrumentation }}
      smoke_test_classes: ${{ steps.detect.outputs.smoke_test_classes }}
      changed_files_count: ${{ steps.detect.outputs.changed_files_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect affected modules and tasks
        id: detect
        run: bash scripts/quality/affected-modules.sh --format github >> "$GITHUB_OUTPUT"

      - name: Print affected plan
        run: |
          echo "scope=${{ steps.detect.outputs.affected_scope }}"
          echo "modules=${{ steps.detect.outputs.affected_modules }}"
          echo "verify_tasks=${{ steps.detect.outputs.verify_tasks }}"
          echo "run_instrumentation=${{ steps.detect.outputs.run_instrumentation }}"
          echo "smoke_test_classes=${{ steps.detect.outputs.smoke_test_classes }}"
          echo "changed_files_count=${{ steps.detect.outputs.changed_files_count }}"

  verify-build:
    needs: detect-affected
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Verify Gradle stability
        run: bash scripts/quality/verify_gradle_stability.sh

      - name: Verify CI workflow quality guardrails
        run: bash scripts/quality/verify_ci_workflow_quality.sh

      - name: Run affected verification tasks
        run: ./gradlew --no-daemon ${{ needs.detect-affected.outputs.verify_tasks }}

      - name: Enforce release exported component allowlist
        run: bash scripts/quality/verify_release_exported_components.sh

      - name: Enforce lint warning allowlist
        run: bash scripts/lint/verify_lint_warning_allowlist.sh app/build/reports/lint-results-debug.txt

      - name: Enforce coroutine cancellation guards
        run: bash scripts/quality/verify_cancellation_guards.sh app/src/main/kotlin

      - name: Enforce no empty catch blocks
        run: bash scripts/quality/verify_no_empty_catch_blocks.sh app/src/main/kotlin

      - name: Enforce target SDK upgrade gate
        run: bash scripts/quality/verify_target_sdk_upgrade.sh constants.gradle.kts .github/workflows/android-ci.yml

      - name: Enforce exact alarm permission config
        run: bash scripts/quality/verify_exact_alarm_permission_config.sh app/src/main/AndroidManifest.xml

      - name: Enforce architecture boundaries
        run: bash scripts/quality/verify_architecture_boundaries.sh .

      - name: Enforce module API visibility
        run: bash scripts/quality/verify_module_api_visibility.sh app/src/main/kotlin/com/ytone/longcare

      - name: Upload APK
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
          retention-days: 14

      - name: Upload AAB
        if: needs.detect-affected.outputs.affected_scope == 'full'
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-aab
          path: app/build/outputs/bundle/debug/*.aab
          if-no-files-found: error
          retention-days: 14

      - name: Upload release AAB
        if: needs.detect-affected.outputs.affected_scope == 'full'
        uses: actions/upload-artifact@v6
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 14

      - name: Upload baselineprofile APKs
        if: needs.detect-affected.outputs.affected_scope == 'full'
        uses: actions/upload-artifact@v6
        with:
          name: baselineprofile-apks
          path: baselineprofile/build/outputs/apk/**/*.apk
          if-no-files-found: warn
          retention-days: 14

      - name: Upload test and lint reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: app-reports
          path: |
            app/build/reports/**
            app/build/test-results/**
            build/reports/problems/**
          if-no-files-found: warn
          retention-days: 14

  instrumentation-smoke:
    needs:
      - detect-affected
      - verify-build
    if: needs.detect-affected.outputs.run_instrumentation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Verify Gradle stability
        run: bash scripts/quality/verify_gradle_stability.sh

      - name: Assemble instrumentation APKs
        run: ./gradlew --no-daemon :app:assembleDebug :app:assembleDebugAndroidTest -Pbaseline.enableX86_64=true

      - name: Resolve target SDK for emulator smoke
        id: target_sdk
        run: |
          TARGET_SDK=$(sed -nE 's/.*appTargetSdkVersion by extra\(([0-9]+)\).*/\1/p' constants.gradle.kts | head -n1)
          if [ -z "${TARGET_SDK}" ]; then
            echo "Failed to parse appTargetSdkVersion from constants.gradle.kts"
            exit 1
          fi
          echo "value=${TARGET_SDK}" >> "$GITHUB_OUTPUT"
          echo "Using emulator API level: ${TARGET_SDK}"

      - name: Free disk space for emulator
        run: bash scripts/quality/free_runner_disk_space.sh --min-free-mb 8192

      - name: Run instrumentation smoke test on emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ steps.target_sdk.outputs.value }}
          target: default
          arch: x86_64
          force-avd-creation: true
          cores: 2
          ram-size: 2048M
          disk-size: 2048M
          emulator-boot-timeout: 900
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot-load -no-snapshot-save -no-metrics
          disable-animations: true
          disable-linux-hw-accel: true
          script: SMOKE_TEST_CLASSES="${{ needs.detect-affected.outputs.smoke_test_classes }}" bash ./.github/scripts/run-instrumentation-smoke.sh

      - name: Upload instrumentation reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: instrumentation-smoke-reports
          path: |
            app/build/reports/androidTests/**
            app/build/outputs/androidTest-results/**
          if-no-files-found: warn
          retention-days: 14
