name: Android CI

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
  workflow_dispatch:

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_TOOL_OPTIONS: -Djava.awt.headless=true

jobs:
  verify-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run verification and packaging
        run: ./gradlew --no-daemon :app:lintDebug :app:testDebugUnitTest :app:assembleDebug :app:bundleDebug :baselineprofile:assemble :app:bundleRelease

      - name: Enforce lint warning allowlist
        run: bash scripts/lint/verify_lint_warning_allowlist.sh app/build/reports/lint-results-debug.txt

      - name: Enforce coroutine cancellation guards
        run: bash scripts/quality/verify_cancellation_guards.sh app/src/main/kotlin

      - name: Enforce no empty catch blocks
        run: bash scripts/quality/verify_no_empty_catch_blocks.sh app/src/main/kotlin

      - name: Enforce target SDK upgrade gate
        run: bash scripts/quality/verify_target_sdk_upgrade.sh constants.gradle.kts .github/workflows/android-ci.yml

      - name: Upload APK
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
          retention-days: 14

      - name: Upload AAB
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-aab
          path: app/build/outputs/bundle/debug/*.aab
          if-no-files-found: error
          retention-days: 14

      - name: Upload release AAB
        uses: actions/upload-artifact@v6
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 14

      - name: Upload baselineprofile APKs
        uses: actions/upload-artifact@v6
        with:
          name: baselineprofile-apks
          path: baselineprofile/build/outputs/apk/**/*.apk
          if-no-files-found: warn
          retention-days: 14

      - name: Upload test and lint reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: app-reports
          path: |
            app/build/reports/**
            app/build/test-results/**
            build/reports/problems/**
          if-no-files-found: warn
          retention-days: 14

  instrumentation-smoke:
    needs: verify-build
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Assemble instrumentation APKs
        run: ./gradlew --no-daemon :app:assembleDebug :app:assembleDebugAndroidTest -Pbaseline.enableX86_64=true

      - name: Resolve target SDK for emulator smoke
        id: target_sdk
        run: |
          TARGET_SDK=$(sed -nE 's/.*appTargetSdkVersion by extra\(([0-9]+)\).*/\1/p' constants.gradle.kts | head -n1)
          if [ -z "${TARGET_SDK}" ]; then
            echo "Failed to parse appTargetSdkVersion from constants.gradle.kts"
            exit 1
          fi
          echo "value=${TARGET_SDK}" >> "$GITHUB_OUTPUT"
          echo "Using emulator API level: ${TARGET_SDK}"

      - name: Free disk space for emulator
        run: |
          echo "Disk usage before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /opt/hostedtoolcache/CodeQL || true
          echo "Disk usage after cleanup:"
          df -h /
          FREE_MB=$(df -Pm / | awk 'NR==2 {print $4}')
          if [ "$FREE_MB" -lt 8192 ]; then
            echo "Insufficient free disk space for emulator userdata partition: ${FREE_MB}MB available."
            exit 1
          fi

      - name: Run instrumentation smoke test on emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ steps.target_sdk.outputs.value }}
          target: default
          arch: x86_64
          force-avd-creation: true
          cores: 2
          ram-size: 2048M
          disk-size: 2048M
          emulator-boot-timeout: 900
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot-load -no-snapshot-save -no-metrics
          disable-animations: true
          disable-linux-hw-accel: true
          script: SMOKE_TEST_CLASSES="com.ytone.longcare.smoke.MainActivitySmokeTest,com.ytone.longcare.features.service.ServiceTimeNotificationIntegrationTest" bash ./.github/scripts/run-instrumentation-smoke.sh

      - name: Upload instrumentation reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: instrumentation-smoke-reports
          path: |
            app/build/reports/androidTests/**
            app/build/outputs/androidTest-results/**
          if-no-files-found: warn
          retention-days: 14
